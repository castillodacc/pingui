<template>
  <div class="row" v-if="can('inscription.store')">
    <form @submit.prevent="register" v-if="r === true">
      <h4>Datos de pareja</h4>
      <div class="col-md-6">
        <div class="form-group">
          <label for="name_1" class="control-label">
            <span class="fa fa-name_1"></span> Bailarín:
          </label>
          <input
            id="name_1"
            type="text"
            disabled=""
            v-model="pareja1"
            class="form-control"
          />
          <small
            id="name_1Help"
            v-text="msg.name_1"
            class="form-text text-muted"
          ></small>
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-group">
          <label for="name_2" class="control-label">
            <span class="fa fa-name_2"></span> Bailarina:
          </label>
          <input
            id="name_2"
            type="text"
            disabled=""
            v-model="pareja2"
            class="form-control"
          />
          <small
            id="name_2Help"
            v-text="msg.name_2"
            class="form-text text-muted"
          ></small>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <div class="row">
            <h4>Seleccione la modalidad que desea bailar:</h4>
            <div class="col-md-4">
              <p>Standard:</p>
              <template v-for="p in tournament.prices">
                <div
                  :key="p.id"
                  class="form-inline"
                  v-if="
                    p.category_id == 3 &&
                    data.category_s == p.level_id &&
                    data.group_s == p.subcategory_id
                  "
                >
                  <label :for="p.id">
                    <input
                      class=""
                      :id="p.id"
                      :value="p.id"
                      type="checkbox"
                      v-model="prices"
                    />
                    {{ p.level_text }} - {{ p.subcategory_text }} -
                    {{ p.price }} €
                  </label>
                </div>
              </template>
            </div>
            <div class="col-md-4">
              <p>Latino:</p>
              <template v-for="p in tournament.prices">
                <div
                  :key="p.id"
                  class="form-inline"
                  v-if="
                    p.category_id == 2 &&
                    data.category_l == p.level_id &&
                    data.group_l == p.subcategory_id
                  "
                >
                  <label :for="p.id">
                    <input
                      class=""
                      :id="p.id"
                      :value="p.id"
                      type="checkbox"
                      v-model="prices"
                    />
                    {{ p.level_text }} - {{ p.subcategory_text }} -
                    {{ p.price }} €
                  </label>
                </div>
              </template>
            </div>
            <div class="col-md-4">
              <p>Open:</p>
              <template v-for="p in tournament.prices">
                <div class="form-inline" :key="p.id" v-if="p.category_id == 1">
                  <label :for="p.id">
                    <input
                      class=""
                      :id="p.id"
                      :value="p.id"
                      type="checkbox"
                      v-model="prices"
                    />
                    {{ p.level_text }} - {{ p.price }} €
                  </label>
                </div>
              </template>
            </div>
            <h4>
              Total a Pagar: <b>{{ inscription.pay }} €</b>
            </h4>
          </div>
          <div class="col-md-12" v-show="inscription.price.length">
            <p>Seleccione el tipo de pago:</p>
            <div class="col-md-12">
              <div
                @click="changeType(1)"
                class="col-md-4 btn borde"
                :class="{
                  'btn-black': inscription.method_pay == 1,
                }"
                v-if="
                  tournament.organizer &&
                  tournament.organizer.headline &&
                  tournament.organizer.account &&
                  tournament.organizer.bank
                "
              >
                Transferencia
              </div>
              <div
                @click="changeType(2)"
                class="col-md-4 btn borde"
                :class="{
                  'btn-black': inscription.method_pay == 2,
                }"
                v-if="
                  tournament.organizer.paypal_client_id &&
                  tournament.organizer.paypal_client_secret
                "
              >
                Paypal
              </div>
              <div
                @click="changeType(3)"
                class="col-md-4 btn borde"
                :class="{
                  'btn-black': inscription.method_pay == 3,
                }"
                v-if="
                  tournament.organizer.t_publishable_key &&
                  tournament.organizer.t_secret_key
                "
              >
                Tarjeta
              </div>
            </div>
            <small
              id="method_payHelp"
              v-text="msg.method_pay"
              class="form-text text-muted"
            ></small>
            <div
              class="col-md-12"
              v-if="
                inscription.method_pay == 1 &&
                tournament.organizer.bank &&
                tournament.organizer.headline &&
                tournament.organizer.account
              "
            >
              <p style="font-size: 14px">
                Guarde los datos bancarios y deposite la cantidad acordada.
              </p>
              <p style="margin: 0">
                Banco: <b>{{ tournament.organizer.bank }}</b>
              </p>
              <p style="margin: 0">
                Cuenta:
                <b>{{ tournament.organizer.account }}</b>
              </p>
              <p style="margin: 0">
                Titular:
                <b>{{ tournament.organizer.headline }}</b>
              </p>
              <p style="margin: 0">
                Total: <b>{{ inscription.pay }} €</b>
              </p>
            </div>
            <div
              class="form-row"
              id="payment-form"
              v-show="
                inscription.method_pay == 3 &&
                tournament.organizer.t_publishable_key &&
                tournament.organizer.t_secret_key
              "
            >
              <div class="form-row">
                <label for="card-element"> Tarjeta de Débito y Crédito </label>
                <div id="card-element">
                  <!-- A Stripe Element will be inserted here. -->
                </div>
                <!-- Used to display form errors. -->
                <div id="card-errors" role="alert"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-12">
        <div class="span pull-right" style="padding: 15px">
          <button
            type="button"
            @click="open"
            class="btn btn-black"
            :disabled="
              pareja1 && pareja2 && prices && inscription.method_pay.length
            "
          >
            Registrar
          </button>
        </div>
      </div>
      <div
        id="confirm"
        role="dialog"
        class="modal fade"
        aria-hidden="true"
        data-keyboard="false"
        data-backdrop="static"
      >
        <div class="modal-dialog" role="document" style="top: 100px">
          <div class="modal-content">
            <div class="modal-header btn-black">
              <button
                type="button"
                class="close"
                aria-label="Close"
                data-dismiss="modal"
              >
                <span aria-hidden="true">&times;</span>
              </button>
              <h4 class="modal-title">
                ¿Esta Seguro de Registrar su participación en esta competición?
              </h4>
            </div>
            <div class="modal-body">
              <p>Pareja: {{ pareja1 }} y {{ pareja2 }}</p>
              <small id="name_1Help" class="form-text text-muted"></small>
              <small id="name_2Help" class="form-text text-muted"></small>
              <p>
                Categorias:
                <template v-for="(p, i) in prices">
                  <span :key="i" class="label label-info">{{
                    namePrice(p)
                  }}</span>
                  <span :key="`${i}-1`"> </span>
                </template>
              </p>
              <small id="priceHelp" class="form-text text-muted"></small>
              <p>
                Método de Pago:
                <span v-if="inscription.method_pay == 1">Transferencia</span>
                <span v-if="inscription.method_pay == 2">PayPal</span>
                <span v-if="inscription.method_pay == 3">Tarjeta</span>
              </p>
              <small id="method_payHelp" class="form-text text-muted"></small>
              <p>Total a Pagar: {{ inscription.pay }} €</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-danger" data-dismiss="modal">
                Cancelar
              </button>
              <button
                type="submit"
                class="btn btn-success"
                :disabled="!button_finish"
              >
                Confirmar
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>
    <div class="col-md-12" v-if="r === false">
      <div class="alert alert-success">
        <h3 class="text-center" style="margin: 0">
          Tu registro a la competición se ha finalizado correctamente..
        </h3>
        <p>
          Hola {{ data.name }} {{ data.last_name }}, Se ha registrado
          correctamente en la competición.
        </p>
        <p>
          <b>Estado del pago: </b>
          <span v-if="t.state_pay == 1">Ya fué aprobado su pago...</span>
          <span v-else>En espera de aprobación...</span>
        </p>
        <p>
          <b>Estado de Participación: </b>
          <span v-if="t.state == 1"
            >Ya fué aprobada su participación en la competencia...</span
          >
          <span v-else>En espera de aprobación...</span>
        </p>
        <div class="row">
          <div class="col-md-12">
            <template v-for="p in t.prices">
              <span
                :key="p.id"
                class="label label-info"
                style="display: inline; font-size: 1em; margin-right: 10px"
              >
                {{ cate(p.category_id) }} -
                {{ namePrice(p.id) }}
              </span>
              <wbr :key="`${p.id}-1`" />
            </template>
          </div>
        </div>
        <hr />
        <p>
          <a
            class="btn btn-black"
            v-if="can('inscription.index')"
            :href="'/lista/' + tournament.slug"
            >Ver Lista de inscritos</a
          >
        </p>
        <div v-if="t.method_pay == 1 && !t.state">
          <p style="font-size: 14px">
            No te olvides de llevar a cabo la forma de pago seleccionada.
          </p>
          <p style="margin: 0">
            Banco: <b>{{ tournament.organizer.bank }}</b>
          </p>
          <p style="margin: 0">
            Cuenta: <b>{{ tournament.organizer.account }}</b>
          </p>
          <p style="margin: 0">
            Titular: <b>{{ tournament.organizer.headline }}</b>
          </p>
          <p style="margin: 0">
            Total: <b>{{ t.pay }} €</b>
          </p>
        </div>
      </div>
    </div>
  </div>
</template>

<style>
.borde {
  border: 1px solid;
}
p {
  font-size: 1.3em;
}
.StripeElement {
  background-color: white;
  height: 40px;
  padding: 10px 12px;
  border-radius: 4px;
  border: 1px solid transparent;
  box-shadow: 0 1px 3px 0 #e6ebf1;
  -webkit-transition: box-shadow 150ms ease;
  transition: box-shadow 150ms ease;
}
.StripeElement--focus {
  box-shadow: 0 1px 3px 0 #cfd7df;
}
.StripeElement--invalid {
  border-color: #fa755a;
}
.StripeElement--webkit-autofill {
  background-color: #fefde5 !important;
}
</style>

<script>
import Multiselect from "vue-multiselect";
export default {
  name: "Inscription",
  props: ["id"],
  components: { "rs-multiselect": Multiselect },
  data() {
    return {
      button_finish: true,
      stripe_objec: {},
      card: {},
      prices: [],
      pareja1: "",
      pareja2: "",
      t: {},
      r: "",
      data: {},
      tournament: {
        organizer: {},
      },
      msg: {
        febd_num_1: "Pareja seleccionada.",
        febd_num_2: "Pareja seleccionada.",
        method_pay: "Señale el tipo de pago.",
      },
      inscription: {
        user_id: "",
        tournament_id: "",
        febd_num_1: "",
        last_name_1: "",
        name_1: "",
        febd_num_2: "",
        name_2: "",
        last_name_2: "",
        price: "",
        method_pay: "",
        pay: 0,
      },
    };
  },
  watch: {
    prices: function (val) {
      let price = 0,
        test = 0;
      for (let i in val) {
        for (let o in this.tournament.prices) {
          if (this.tournament.prices[o].id == val[i]) {
            if (this.tournament.prices[o].category_id == 1) {
              price += Number(this.tournament.prices[o].price);
            }
            if (
              (this.tournament.prices[o].category_id == 2 ||
                this.tournament.prices[o].category_id == 3) &&
              test == 0
            ) {
              price += Number(this.tournament.prices[o].price);
              test++;
            }
            continue;
          }
        }
      }
      this.inscription.price = val;
      this.inscription.pay = Number(price);
    },
  },
  mounted() {
    setTimeout(() => {
      this.inscription.tournament_id = this.id;
      this.get();
    }, 300);
  },
  methods: {
    namePrice: function (id) {
      for (let o in this.tournament.prices) {
        if (this.tournament.prices[o].id == id) {
          return (
            this.tournament.prices[o].level_text +
            (this.tournament.prices[o].subcategory_text
              ? " - " + this.tournament.prices[o].subcategory_text
              : "")
          );
        }
      }
    },
    get: function () {
      axios.post("/get-data", { id: this.id }).then((response) => {
        if (this.can("inscription.store")) {
          this.tournament = response.data.tournament;
          this.inscription.user_id = response.data.user.id;
          let price = response.data.tournament.prices;
          this.data = response.data.user;
          this.r = response.data.state.id ? false : true;
          this.t = response.data.state;
          let pareja = response.data.user.parejas;
          if (this.can("inscription.store2")) {
            if (pareja[0]) {
              this.pareja1 =
                (pareja[0].febd_num ? pareja[0].febd_num : "") +
                " - " +
                pareja[0].name +
                " " +
                pareja[0].last_name;
              this.inscription.febd_num_1 = pareja[0].febd_num;
              this.inscription.last_name_1 = pareja[0].last_name;
              this.inscription.name_1 = pareja[0].name;
            } else {
              this.msg.febd_num_1 = "Agrege la pareja en el perfil";
            }
            if (pareja[1]) {
              this.pareja2 =
                (pareja[1].febd_num ? pareja[1].febd_num : "") +
                " - " +
                pareja[1].name +
                " " +
                pareja[1].last_name;
              this.inscription.febd_num_2 = pareja[1].febd_num;
              this.inscription.last_name_2 = pareja[1].last_name;
              this.inscription.name_2 = pareja[1].name;
            } else {
              this.msg.febd_num_2 = "Agrege la pareja en el perfil";
            }
          } else {
            if (this.data.sex == 0) {
              this.pareja2 =
                (this.data.febd_num ? this.data.febd_num : "") +
                " - " +
                this.data.name +
                " " +
                this.data.last_name;
              this.inscription.febd_num_2 = this.data.febd_num;
              this.inscription.name_2 = this.data.name;
              this.inscription.last_name_2 = this.data.last_name;
              if (pareja[0]) {
                this.pareja1 =
                  (pareja[0].febd_num ? pareja[0].febd_num : "") +
                  " - " +
                  pareja[0].name +
                  " " +
                  pareja[0].last_name;
                this.inscription.febd_num_1 = pareja[0].febd_num;
                this.inscription.last_name_1 = pareja[0].last_name;
                this.inscription.name_1 = pareja[0].name;
              } else {
                this.msg.febd_num_1 = "Agrege la pareja en el perfil";
              }
            } else {
              this.pareja1 =
                (this.data.febd_num ? this.data.febd_num : "") +
                " - " +
                this.data.name +
                " " +
                this.data.last_name;
              this.inscription.febd_num_1 = this.data.febd_num;
              this.inscription.name_1 = this.data.name;
              this.inscription.last_name_1 = this.data.last_name;
              if (pareja[0]) {
                this.pareja2 =
                  (pareja[0].febd_num ? pareja[0].febd_num : "") +
                  " - " +
                  pareja[0].name +
                  " " +
                  pareja[0].last_name;
                this.inscription.febd_num_2 = pareja[0].febd_num;
                this.inscription.last_name_2 = pareja[0].last_name;
                this.inscription.name_2 = pareja[0].name;
              } else {
                this.msg.febd_num_2 = "Agrege la pareja en el perfil";
              }
            }
          }
          if (
            this.tournament.organizer.t_publishable_key &&
            this.tournament.organizer.t_secret_key
          ) {
            this.stripe(this.tournament.organizer.t_publishable_key);
          }
        }
      });
    },
    cate: function (n) {
      if (n === 1) {
        return "Open";
      } else if (n === 2) {
        return "Latino";
      } else if (n === 3) {
        return "Standard";
      }
    },
    changeType: function (num) {
      this.inscription.method_pay = num;
    },
    open: function () {
      $("#confirm").modal("show");
      setTimeout(function () {
        $("#confirm, body").css({ "padding-right": "0px" });
      }, 100);
      $(".modal-backdrop").hide();
    },
    register: function (event) {
      this.button_finish = false;
      if (this.inscription.method_pay == 3) {
        this.stripe_objec.createToken(this.card).then((result) => {
          if (result.error) {
            // Inform the user if there was an error.
            var errorElement = document.getElementById("card-errors");
            errorElement.textContent = result.error.message;
            toastr.info("Error En la conexión");
          } else {
            // Send the token to your server.
            this.inscription.stripeToken = result.token.id;
            // this.stripeTokenHandler(result.token);
            this.send();
          }
        });
      } else {
        this.send();
      }
    },
    send: function () {
      toastr.info("Procesando Información, ¡por favor espere!");
      axios.post("/inscription", this.inscription).then((response) => {
        if (this.inscription.method_pay == 2) {
          toastr.success("Registro exitoso, espere respuesta de PayPal");
          setTimeout(() => (window.location.href = response.data), 1000);
        } else {
          toastr.success("Registro exitoso");
          setTimeout(() => window.location.reload(), 1000);
        }
        this.button_finish = true;
      });
    },
    stripe: function (public_key) {
      // Create a Stripe client.
      this.stripe_objec = Stripe(public_key);
      // Create an instance of Elements.
      var elements = this.stripe_objec.elements();
      // Custom styling can be passed to options when creating an Element.
      // (Note that this demo uses a wider set of styles than the guide below.)
      var style = {
        base: {
          color: "#32325d",
          lineHeight: "18px",
          fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
          fontSmoothing: "antialiased",
          fontSize: "16px",
          "::placeholder": {
            color: "#aab7c4",
          },
        },
        invalid: {
          color: "#fa755a",
          iconColor: "#fa755a",
        },
      };
      // Create an instance of the card Element.
      var card = elements.create("card", { style: style });

      // Add an instance of the card Element into the `card-element` <div>.
      setTimeout(() => {
        card.mount("#card-element");
      }, 1000);

      // Handle real-time validation errors from the card Element.
      card.addEventListener("change", function (event) {
        var displayError = document.getElementById("card-errors");
        if (event.error) {
          displayError.textContent = event.error.message;
        } else {
          displayError.textContent = "";
        }
      });
      this.card = card;
    },
  },
};
</script>
